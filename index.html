<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>El Lenguaje de la Mente RPG</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Iconos -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Confetti JS -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lato:wght@300;400;700&display=swap');
        
        body { font-family: 'Lato', sans-serif; background-color: #020617; color: #e2e8f0; height: 100dvh; overflow: hidden; touch-action: pan-y; }
        .font-game { font-family: 'Cinzel', serif; }
        
        /* Glassmorphism Classes */
        .glass-panel {
            background: rgba(2, 6, 23, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .card { 
            @apply glass-panel;
            border-radius: 16px; 
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
        }
        .card:active { transform: scale(0.98); background: rgba(15, 23, 42, 0.9); }
        
        .btn-secondary { background: rgba(51, 65, 85, 0.4); border: 1px solid rgba(255,255,255,0.05); }
        
        /* Animaciones */
        .fade-in { animation: fadeIn 0.6s ease-out forwards; }
        .slide-up { animation: slideUp 0.7s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .float-anim { animation: float 10s ease-in-out infinite; }
        .pulse-slow { animation: pulseSlow 3s infinite; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(40px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes float { 0% { transform: translateY(0px) rotate(0deg); } 50% { transform: translateY(-15px) rotate(2deg); } 100% { transform: translateY(0px) rotate(0deg); } }
        @keyframes pulseSlow { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.8; transform: scale(0.95); } }

        .custom-scrollbar::-webkit-scrollbar { width: 3px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(94, 234, 212, 0.2); border-radius: 4px; }
        
        .stat-box { @apply glass-panel; transition: transform 0.2s; border: 1px solid rgba(255,255,255,0.02); }
        .stat-box:active { transform: scale(0.95); }

        /* Background */
        #bg-pattern {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            overflow: hidden;
            background: radial-gradient(circle at 50% 110%, #0f766e, #020617 70%);
        }
        .bg-icon {
            position: absolute;
            opacity: 0.03;
            color: #ccfbf1;
            filter: blur(0.5px);
        }

        /* Slider */
        .slider-track {
            position: relative;
            height: 56px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 28px;
            border: 1px solid rgba(255,255,255,0.08);
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.6);
            overflow: hidden;
            user-select: none;
            touch-action: none; 
            margin-top: 1rem;
        }
        .slider-knob {
            position: absolute;
            top: 4px;
            left: 50%;
            width: 48px;
            height: 48px;
            margin-left: -24px; 
            background: linear-gradient(135deg, #1e293b, #0f172a);
            border: 1px solid rgba(94, 234, 212, 0.3);
            box-shadow: 0 0 15px rgba(20, 184, 166, 0.2), 0 4px 6px rgba(0,0,0,0.5);
            color: #ccfbf1;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: grab;
            z-index: 20;
            transition: transform 0.1s ease-out, box-shadow 0.2s;
        }
        .slider-knob:active { 
            cursor: grabbing; 
            transform: scale(1.05); 
            box-shadow: 0 0 25px rgba(45, 212, 191, 0.4);
            border-color: #5eead4;
        }
        .slider-knob i { filter: drop-shadow(0 0 2px rgba(45, 212, 191, 0.5)); }
        
        .slider-fill-left {
            position: absolute; top: 0; left: 0; bottom: 0; width: 50%;
            background: linear-gradient(to right, rgba(225, 29, 72, 0.3), transparent);
            opacity: 0; transition: opacity 0.2s;
        }
        .slider-fill-right {
            position: absolute; top: 0; right: 0; bottom: 0; width: 50%;
            background: linear-gradient(to left, rgba(20, 184, 166, 0.3), transparent);
            opacity: 0; transition: opacity 0.2s;
        }
    </style>
</head>
<body class="h-[100dvh] flex flex-col max-w-md mx-auto shadow-2xl overflow-hidden relative border-x border-white/5">

    <div id="bg-pattern"></div>
    <div id="toastContainer" class="fixed top-24 left-4 right-4 z-50 flex flex-col items-center pointer-events-none gap-2"></div>

    <div id="modalOverlay" class="fixed inset-0 bg-slate-950/95 z-50 hidden flex items-center justify-center p-4 backdrop-blur-md transition-opacity opacity-0" aria-hidden="true" onclick="if(event.target === this) toggleModal(false)">
        <div id="modalContent" class="glass-panel border-slate-700/50 rounded-2xl p-6 max-w-sm w-full shadow-2xl transform scale-95 transition-all max-h-[85vh] overflow-y-auto custom-scrollbar bg-slate-900/90">
            <div id="dynamicModalBody"></div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass-panel border-b border-white/5 z-10 flex-none relative m-3 rounded-2xl mb-0">
        <div class="p-4 pb-2">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h1 class="font-game text-xl text-transparent bg-clip-text bg-gradient-to-r from-teal-200 via-cyan-300 to-emerald-200 leading-tight drop-shadow-sm tracking-wide">EL LENGUAJE<br>DE LA MENTE</h1>
                    <p class="text-[10px] text-slate-400 flex items-center gap-1 mt-1 uppercase tracking-widest font-bold">
                        <i data-lucide="brain-circuit" class="w-3 h-3 text-teal-400"></i> Nivel <span id="userLevel" class="text-white">1</span>
                        <span class="mx-1 text-slate-600">|</span>
                        <span id="rankBadge" class="text-amber-400">Iniciado</span>
                    </p>
                </div>
                
                <div class="flex items-center gap-3">
                    <button onclick="showHelp()" class="p-2 bg-white/5 rounded-full hover:bg-white/10 text-teal-300 border border-white/5 transition-colors backdrop-blur-sm shadow-lg group">
                        <i data-lucide="sparkles" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                    </button>
                    <div class="text-right">
                        <div class="text-[9px] text-teal-500 font-bold uppercase tracking-wider mb-0.5">Consciencia</div>
                        <div class="text-xl font-game text-white leading-none drop-shadow-sm" id="currentXp">0</div>
                    </div>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="grid grid-cols-4 gap-2 text-center text-[10px] uppercase font-bold tracking-wider text-slate-500">
                <div onclick="showStatInfo('Gue')" class="stat-box p-2 rounded-lg cursor-pointer hover:bg-white/5 border border-transparent hover:border-red-500/30">
                    <i data-lucide="sword" class="w-4 h-4 mx-auto mb-1 text-red-400"></i>
                    <span class="block text-white text-xs mb-0.5" id="statGue">0</span>Acción
                </div>
                <div onclick="showStatInfo('Sab')" class="stat-box p-2 rounded-lg cursor-pointer hover:bg-white/5 border border-transparent hover:border-blue-500/30">
                    <i data-lucide="eye" class="w-4 h-4 mx-auto mb-1 text-blue-400"></i>
                    <span class="block text-white text-xs mb-0.5" id="statSab">0</span>Mente
                </div>
                <div onclick="showStatInfo('Ama')" class="stat-box p-2 rounded-lg cursor-pointer hover:bg-white/5 border border-transparent hover:border-pink-500/30">
                    <i data-lucide="heart" class="w-4 h-4 mx-auto mb-1 text-pink-400"></i>
                    <span class="block text-white text-xs mb-0.5" id="statAma">0</span>Emoción
                </div>
                <div onclick="showStatInfo('Mag')" class="stat-box p-2 rounded-lg cursor-pointer hover:bg-white/5 border border-transparent hover:border-purple-500/30">
                    <i data-lucide="sparkles" class="w-4 h-4 mx-auto mb-1 text-purple-400"></i>
                    <span class="block text-white text-xs mb-0.5" id="statMag">0</span>Espíritu
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto p-4 space-y-6 scroll-smooth pb-32 relative z-0" id="appContent">
        <!-- Content injected via JS -->
    </main>

    <!-- Navigation -->
    <nav class="glass-panel border-t border-white/5 absolute bottom-0 w-full z-20 m-0 rounded-t-2xl backdrop-blur-xl bg-slate-900/60">
        <div class="flex justify-around p-2 pb-6 pt-3">
            <button onclick="renderMissions()" class="nav-btn flex flex-col items-center text-teal-300 p-2 rounded-xl transition-all active:scale-95 group">
                <div class="p-1 rounded-lg group-hover:bg-teal-500/10 transition"><i data-lucide="swords" class="w-6 h-6"></i></div>
                <span class="text-[9px] font-bold mt-1 uppercase tracking-widest">Retos</span>
            </button>
            <button onclick="renderMentor()" class="nav-btn flex flex-col items-center text-slate-500 p-2 rounded-xl transition-all active:scale-95 group">
                <div class="p-1 rounded-lg group-hover:bg-purple-500/10 transition"><i data-lucide="bot" class="w-6 h-6"></i></div>
                <span class="text-[9px] font-bold mt-1 uppercase tracking-widest">Mentor</span>
            </button>
            <button onclick="renderOrigin()" class="nav-btn flex flex-col items-center text-slate-500 p-2 rounded-xl transition-all active:scale-95 group">
                <div class="p-1 rounded-lg group-hover:bg-amber-500/10 transition"><i data-lucide="book-open-check" class="w-6 h-6"></i></div>
                <span class="text-[9px] font-bold mt-1 uppercase tracking-widest">El Origen</span>
            </button>
            <button onclick="renderProfile()" class="nav-btn flex flex-col items-center text-slate-500 p-2 rounded-xl transition-all active:scale-95 group">
                <div class="p-1 rounded-lg group-hover:bg-emerald-500/10 transition"><i data-lucide="user-circle" class="w-6 h-6"></i></div>
                <span class="text-[9px] font-bold mt-1 uppercase tracking-widest">Yo</span>
            </button>
        </div>
    </nav>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        const APP_VERSION = "4.3.1"; 
        const SAVE_KEY = "lenguajeMente_save_v4";

        const STAT_DEFINITIONS = {
            Gue: { name: "Dominio de la Acción", archetype_group: "El Guerrero", desc: "La capacidad de poner límites y actuar.", icon: "sword", color: "text-red-400" },
            Sab: { name: "Dominio de la Mente", archetype_group: "El Sabio", desc: "La capacidad de observar sin juzgar.", icon: "eye", color: "text-blue-400" },
            Ama: { name: "Dominio de la Emoción", archetype_group: "El Amante", desc: "La capacidad de conectar y sentir.", icon: "heart", color: "text-pink-400" },
            Mag: { name: "Dominio del Espíritu", archetype_group: "El Mago", desc: "La capacidad de transformar la realidad.", icon: "sparkles", color: "text-purple-400" }
        };

        const MENTOR_DATA = {
            judge: [
                "El Juez busca perfección, pero la perfección es un espejismo. Busca progreso.",
                "Dile al Juez: 'Gracias por tu opinión, pero hoy decido yo'. Retoma el mando.",
                "La crítica interna no es verdad, es miedo disfrazado de exigencia.",
                "Cuando te juzgas, te haces pequeño. Cuando te aceptas, te vuelves infinito.",
                "El error no es un crimen, es un dato. Úsalo para calibrar tu brújula.",
                "¿Le hablarías a tu mejor amigo como te hablas a ti mismo? Cambia el tono.",
                "La rigidez se rompe; la flexibilidad se adapta. Sé como el agua, no como la roca.",
                "Tu valor no depende de tus resultados, sino de tu intención.",
                "Observa el juicio como quien observa una nube pasar. No te subas a esa nube.",
                "La compasión es el único antídoto real contra la autocrítica destructiva."
            ],
            victim: [
                "La Víctima pregunta '¿por qué a mí?'. El Héroe pregunta '¿para qué me sirve esto?'.",
                "No eres lo que te pasa, eres lo que decides hacer con lo que te pasa.",
                "Responsabilidad es la habilidad de responder. Tienes más poder del que crees.",
                "La queja es una silla mecedora: te mantiene en movimiento pero no te lleva a ningún lado.",
                "Si culpas a otros de tus problemas, les regalas la llave de tu solución.",
                "Convierte el 'tengo que' en 'elijo que'. Recupera tu agencia.",
                "Hasta en la peor tormenta, tú sigues siendo el capitán de tu barco.",
                "El mundo no te debe nada. Tú te debes todo a ti mismo.",
                "Sal del asiento del pasajero. Es hora de conducir tu propia vida.",
                "Tu historia no está escrita en piedra. Tienes el bolígrafo en la mano ahora mismo."
            ],
            fear: [
                "El miedo es solo una emoción, no una profecía de futuro.",
                "Detrás del muro del miedo suele estar el tesoro de tu crecimiento.",
                "Hazlo con miedo, pero hazlo. La acción disuelve el terror.",
                "El miedo es una señal de que algo te importa, no de que debas parar.",
                "Visualiza el mejor escenario posible, no solo el peor. Tu cerebro cree lo que ve.",
                "La valentía no es ausencia de miedo, es caminar temblando hacia adelante.",
                "¿Qué es lo peor que puede pasar? ¿Y si pasa, qué harías? Tienes recursos.",
                "No dejes que el miedo decida tu menú. Tú eliges qué experiencias comer.",
                "El miedo te quiere seguro en la cueva. Tu alma te quiere libre en el mundo.",
                "Respira profundo. El miedo vive en el futuro; la paz vive en el ahora."
            ],
            wise: [
                "Observa tus pensamientos sin casarte con ellos. Tú eres el cielo, no las nubes.",
                "La consciencia es la luz que disuelve las sombras de los arquetipos.",
                "Para. Respira. En el silencio encuentras las respuestas que el ruido esconde.",
                "No eres tu mente. Eres la consciencia que escucha a tu mente.",
                "La gratitud cambia la química de tu cerebro instantáneamente. Pruébalo.",
                "El momento presente es el único lugar donde tienes poder real.",
                "La sabiduría no es saberlo todo, es saber qué hacer con lo que tienes.",
                "Conecta con tu intención antes de actuar. La intención dirige la energía.",
                "Eres un ser completo en proceso de recordar su completitud.",
                "La vida no te sucede a ti, sucede para ti. Busca el aprendizaje oculto."
            ]
        };

        const lastChatIndices = { judge: -1, victim: -1, fear: -1, wise: -1 };

        const ALL_MISSIONS = [
            { 
                id: 1, title: "El Juez vs. El Observador", villain: "El Juez Interno", hero: "El Observador", 
                desc: "Has cometido un error pequeño. De repente, una voz te susurra: 'Siempre haces lo mismo, no sirves para esto'.", 
                villain_effect: "Te hundes en la culpa. Tu energía baja y te paralizas por miedo a fallar de nuevo.",
                hero_effect: "Reconoces el dato sin el drama. 'Me equivoqué, aprendo y sigo'. Te sientes ligero y capaz.",
                action: "Di en voz alta: 'Gracias por la opinión, Juez'. Y corrige el error sin castigarte.", 
                stat: "Sab", xp: 50, color: "border-blue-500/40" 
            },
            { 
                id: 2, title: "La Víctima vs. El Protagonista", villain: "La Víctima", hero: "El Protagonista", 
                desc: "Sientes que el mundo es injusto contigo. El tráfico, tu jefe, el clima... todo parece estar en tu contra hoy.", 
                villain_effect: "Cedes tu poder al entorno. Te sientes impotente y amargado, esperando que alguien te salve.",
                hero_effect: "Recuperas el control. No puedes cambiar el tráfico, pero sí tu música o tu actitud.",
                action: "Pregúntate: '¿Qué pequeña cosa SÍ depende de mí ahora mismo?' y hazla.", 
                stat: "Gue", xp: 60, color: "border-red-500/40" 
            },
            { 
                id: 3, title: "El Complaciente vs. El Auténtico", villain: "El Complaciente", hero: "El Auténtico", 
                desc: "Te piden un favor que no quieres hacer. Sientes un nudo en el estómago, pero estás a punto de decir 'Sí'.", 
                villain_effect: "Te traicionas a ti mismo. Acumulas resentimiento y cansancio por vivir la vida de otros.",
                hero_effect: "Tu 'No' protege tu energía sagrada. Te respetas a ti mismo y, paradójicamente, los demás te respetan más.",
                action: "Detente. Di: 'Déjame revisarlo y te confirmo'. Prioriza tu paz.", 
                stat: "Ama", xp: 70, color: "border-pink-500/40" 
            },
            { 
                id: 4, title: "El Perfeccionista vs. El Aprendiz", villain: "El Perfeccionista", hero: "El Aprendiz", 
                desc: "Tienes una idea, pero no la lanzas porque 'aún no está lista'. Sigues revisando detalles infinitamente.", 
                villain_effect: "La parálisis por análisis mata tu sueño. El mundo se pierde tu talento por miedo a la crítica.",
                hero_effect: "Entiendes que hecho es mejor que perfecto. Aprendes sobre la marcha y avanzas.",
                action: "Haz un borrador imperfecto hoy mismo. Lánzate al ruedo.", 
                stat: "Mag", xp: 80, color: "border-purple-500/40" 
            },
            { 
                id: 5, title: "Etiquetado Mental", villain: "El Etiquetador", hero: "El Sabio", 
                desc: "Tras un despiste, te dices: 'Soy un desastre'. Estás convirtiendo un hecho puntual en tu identidad.", 
                villain_effect: "Te programas para fallar. Tu cerebro busca pruebas para confirmar que 'eres un desastre'.",
                hero_effect: "Separas tu ser de tu conducta. Eres una persona valiosa que a veces tiene despistes.",
                action: "Reformula: 'Hoy he tenido un comportamiento despistado'. Tú no eres tu conducta.", 
                stat: "Sab", xp: 90, color: "border-blue-500/40" 
            },
            { 
                id: 6, title: "La Comparación", villain: "El Envidioso", hero: "El Inspirado", 
                desc: "Ves el éxito de alguien en redes y sientes un pinchazo en el estómago. Te sientes pequeño/a.", 
                villain_effect: "La envidia es veneno. Te hace creer que el éxito es un recurso limitado y que tú no alcanzas.",
                hero_effect: "La admiración es medicina. Si esa persona pudo, es la prueba de que es posible para ti.",
                action: "Bendice su éxito y úsalo como mapa. 'Gracias por mostrarme lo que es posible'.", 
                stat: "Ama", xp: 85, color: "border-pink-500/40" 
            },
            { 
                id: 7, title: "La Catástrofe Futura", villain: "El Agorero", hero: "El Presente", 
                desc: "Tu mente viaja al futuro creando películas de terror sobre cosas que aún no han pasado.", 
                villain_effect: "Sufres dos veces: una en tu imaginación y otra si ocurre. Vives en ansiedad constante.",
                hero_effect: "Vuelves al refugio del ahora. Aquí y ahora, estás a salvo y tienes recursos.",
                action: "Respira hondo. Nombra 3 objetos que veas ahora mismo. Ancla tu mente.", 
                stat: "Mag", xp: 75, color: "border-purple-500/40" 
            },
            { 
                id: 8, title: "Poner Límites", villain: "Miedo al Rechazo", hero: "El Guerrero", 
                desc: "Alguien invade tu tiempo o espacio personal. Sientes rabia pero sonríes.", 
                villain_effect: "Tu cuerpo grita lo que tu boca calla. La rabia no expresada se vuelve contra ti.",
                hero_effect: "Defines tu territorio. Tus relaciones se vuelven más sanas y honestas.",
                action: "Comunica tu límite con firmeza pero sin agresividad. 'No puedo hacer eso ahora'.", 
                stat: "Gue", xp: 100, color: "border-red-500/40" 
            },
            { 
                id: 9, title: "Pedir Ayuda", villain: "El Autosuficiente", hero: "El Humilde", 
                desc: "Estás desbordado/a pero crees que pedir ayuda es de débiles. Te cargas todo a la espalda.", 
                villain_effect: "Te agotas y te aíslas. Niegas a los demás el regalo de contribuir a tu vida.",
                hero_effect: "Te conectas con tu humanidad. La vulnerabilidad es el puente hacia la conexión real.",
                action: "Solicita apoyo a alguien hoy. Di: 'Necesito una mano con esto'.", 
                stat: "Ama", xp: 90, color: "border-pink-500/40" 
            },
            { 
                id: 10, title: "Celebrar Logros", villain: "El Exigente", hero: "El Celebrador", 
                desc: "Terminas un gran proyecto y, en lugar de alegrarte, ya estás pensando en el siguiente pendiente.", 
                villain_effect: "Vives en una carrera sin meta. Nada es suficiente nunca, lo que lleva al vacío.",
                hero_effect: "Llenas tu depósito de dopamina. Celebrar te da energía para el siguiente reto.",
                action: "Para 5 minutos. Siéntete orgulloso/a. Regálate un pequeño premio.", 
                stat: "Mag", xp: 110, color: "border-purple-500/40" 
            }
        ];

        for(let i=11; i<40; i++) {
             const types = ["Gue", "Sab", "Ama", "Mag"];
             const type = types[i % 4];
             const colors = {"Gue": "border-red-500/40", "Sab": "border-blue-500/40", "Ama": "border-pink-500/40", "Mag": "border-purple-500/40"};
             
             ALL_MISSIONS.push({ 
                id: i, 
                title: `Entrenamiento ${STAT_DEFINITIONS[type].name}`, 
                villain: "La Inercia", 
                hero: "La Constancia", 
                desc: "La motivación te arranca, pero el hábito te mantiene. Hoy la pereza intenta convencerte de posponer.", 
                villain_effect: "Cada vez que pospones, debilitas la confianza en tu propia palabra.",
                hero_effect: "Cada pequeña acción suma votos para la persona que quieres ser.",
                action: "Realiza una sola acción pequeña alineada con tu meta hoy.", 
                stat: type, 
                xp: 100 + (i*5), 
                color: colors[type] 
            });
        }

        const TOTAL_MAX_XP = ALL_MISSIONS.reduce((sum, m) => sum + m.xp, 0);
        const RANKS = [{ threshold: 0, title: "Durmiente" }, { threshold: 10, title: "Despierto" }, { threshold: 25, title: "Aprendiz" }, { threshold: 50, title: "Arquitecto" }, { threshold: 75, title: "Maestro" }, { threshold: 95, title: "Héroe Integrado" }];

        let gameState = { version: APP_VERSION, xp: 0, level: 1, stats: { Gue: 1, Sab: 1, Ama: 1, Mag: 1 }, activeIds: [], pendingIds: [], completedIds: [], skippedIds: [] };

        function generateBackground() {
            const bgContainer = document.getElementById('bg-pattern');
            bgContainer.innerHTML = '';
            const icons = ['brain', 'zap', 'feather', 'sun', 'moon', 'key'];
            const count = 20; 
            for (let i = 0; i < count; i++) {
                const iconName = icons[Math.floor(Math.random() * icons.length)];
                const el = document.createElement('div');
                el.className = 'bg-icon float-anim';
                el.style.left = Math.random() * 100 + '%';
                el.style.top = Math.random() * 100 + '%';
                const size = Math.floor(Math.random() * 40) + 10; 
                el.style.width = size + 'px';
                el.style.height = size + 'px';
                el.style.animationDelay = (Math.random() * 5) + 's';
                el.style.animationDuration = (Math.random() * 15 + 10) + 's'; 
                el.innerHTML = `<i data-lucide="${iconName}" style="width:100%; height:100%"></i>`;
                bgContainer.appendChild(el);
            }
        }

        // --- FOOTER ACTUALIZADO CON VISIBILIDAD MEJORADA ---
        const FOOTER_HTML = `
            <div class="text-center pt-8 pb-24 opacity-60 hover:opacity-100 transition-opacity duration-500 cursor-default select-none space-y-2">
                <p class="text-[9px] text-teal-200/70 font-medium tracking-widest uppercase">INSPIRED BY "EL LENGUAJE DE LA MENTE"</p>
                <p class="flex items-center justify-center gap-1 text-[10px] text-slate-300 font-medium">
                    Made with <i data-lucide="heart" class="w-3 h-3 text-red-500 fill-red-500 animate-pulse"></i> by the Liderapia team for you
                </p>
                <p class="text-[9px] text-slate-400 font-mono tracking-wider">v${APP_VERSION}</p>
            </div>
        `;

        function initGame() {
            generateBackground();
            const saved = localStorage.getItem(SAVE_KEY);
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    gameState = { ...gameState, ...parsed };
                    if(gameState.activeIds.length === 0 && gameState.pendingIds.length === 0 && gameState.completedIds.length === 0) setupNewGame();
                } catch (e) { setupNewGame(); }
            } else { setupNewGame(); }
            updateUI();
            renderView();
        }

        function setupNewGame() {
            const allIds = ALL_MISSIONS.map(m => m.id);
            gameState.activeIds = allIds.slice(0, 4);
            gameState.pendingIds = allIds.slice(4);
            gameState.xp = 0; gameState.level = 1; gameState.stats = { Gue: 1, Sab: 1, Ama: 1, Mag: 1 };
            gameState.completedIds = []; gameState.skippedIds = [];
            saveGame();
        }

        function saveGame() { localStorage.setItem(SAVE_KEY, JSON.stringify(gameState)); updateUI(); }
        function getMissionById(id) { return ALL_MISSIONS.find(m => m.id === id); }

        function showMissionDetails(id) {
            const m = getMissionById(id);
            const html = `
                <div class="text-left font-sans">
                    <div class="text-center mb-6">
                        <span class="text-[10px] uppercase font-bold tracking-[0.3em] text-teal-500/60 block mb-2">Análisis del Conflicto</span>
                        <h3 class="text-2xl font-bold text-white leading-tight font-game mb-2">${m.title}</h3>
                        <div class="h-0.5 w-12 bg-teal-500/30 mx-auto rounded-full"></div>
                    </div>

                    <div class="bg-slate-900/40 p-5 rounded-2xl border border-white/5 mb-6 shadow-inner">
                        <p class="text-slate-300 text-sm leading-relaxed font-serif italic text-center">"${m.desc}"</p>
                    </div>
                    
                    <h4 class="text-xs font-bold text-center text-slate-400 uppercase tracking-widest mb-4">La Encrucijada</h4>

                    <div class="space-y-4 mb-8">
                        <div class="relative overflow-hidden group">
                            <div class="absolute inset-0 bg-gradient-to-r from-red-900/20 to-transparent opacity-50 group-hover:opacity-70 transition-opacity"></div>
                            <div class="border-l-4 border-red-500/50 bg-slate-900/40 p-4 rounded-r-xl relative z-10">
                                <div class="flex items-center gap-2 mb-1">
                                    <i data-lucide="arrow-left" class="w-4 h-4 text-red-400"></i>
                                    <span class="text-[10px] font-bold uppercase text-red-400 tracking-wider">Si evitas (El Villano)</span>
                                </div>
                                <p class="text-sm text-slate-300 leading-relaxed">${m.villain_effect}</p>
                            </div>
                        </div>

                        <div class="relative overflow-hidden group">
                            <div class="absolute inset-0 bg-gradient-to-l from-teal-900/20 to-transparent opacity-50 group-hover:opacity-70 transition-opacity"></div>
                            <div class="border-r-4 border-teal-500/50 bg-slate-900/40 p-4 rounded-l-xl text-right relative z-10">
                                <div class="flex items-center gap-2 mb-1 justify-end">
                                    <span class="text-[10px] font-bold uppercase text-teal-400 tracking-wider">Si integras (El Héroe)</span>
                                    <i data-lucide="arrow-right" class="w-4 h-4 text-teal-400"></i>
                                </div>
                                <p class="text-sm text-white leading-relaxed font-medium">${m.hero_effect}</p>
                            </div>
                        </div>
                    </div>

                    <div class="text-center mb-6">
                        <p class="text-xs text-slate-400 mb-2">Para activar al Héroe:</p>
                        <p class="text-teal-200 font-bold text-sm bg-teal-500/10 py-3 px-4 rounded-xl border border-teal-500/20 inline-block shadow-[0_0_15px_rgba(20,184,166,0.1)]">
                            <i data-lucide="zap" class="w-3 h-3 inline mr-1"></i> ${m.action}
                        </p>
                    </div>

                    <button onclick="toggleModal(false)" class="w-full py-4 bg-slate-800 hover:bg-slate-700 text-slate-300 hover:text-white rounded-xl font-bold transition-all border border-white/10 text-xs uppercase tracking-[0.2em] shadow-lg">
                        Volver y Decidir
                    </button>
                </div>
            `;
            toggleModal(true, html);
            lucide.createIcons();
        }

        function setupSliders() {
            const sliders = document.querySelectorAll('.slider-knob');
            sliders.forEach(knob => {
                const track = knob.parentElement;
                const fillLeft = track.querySelector('.slider-fill-left');
                const fillRight = track.querySelector('.slider-fill-right');
                const missionId = parseInt(knob.dataset.missionId);
                let isDragging = false, startX = 0, currentTranslate = 0;
                let maxMove = (track.offsetWidth / 2) - (knob.offsetWidth / 2) - 2;

                const resetSlider = () => { knob.style.transform = `translateX(0px)`; fillLeft.style.opacity = '0'; fillRight.style.opacity = '0'; currentTranslate = 0; };
                const onMove = (clientX) => {
                    if (!isDragging) return;
                    const deltaX = clientX - startX;
                    const clampedDelta = Math.max(-maxMove, Math.min(maxMove, deltaX));
                    knob.style.transform = `translateX(${clampedDelta}px)`;
                    const progress = Math.abs(clampedDelta) / maxMove;
                    if (clampedDelta > 0) { fillRight.style.opacity = progress; fillLeft.style.opacity = 0; } 
                    else { fillLeft.style.opacity = progress; fillRight.style.opacity = 0; }
                    currentTranslate = clampedDelta;
                };
                const onEnd = () => {
                    if (!isDragging) return;
                    isDragging = false;
                    const threshold = maxMove * 0.65;
                    if (currentTranslate > threshold) completeMission(missionId);
                    else if (currentTranslate < -threshold) skipMission(missionId);
                    else resetSlider();
                };

                knob.addEventListener('mousedown', (e) => { isDragging = true; startX = e.clientX; e.preventDefault(); });
                window.addEventListener('mousemove', (e) => { if(isDragging) onMove(e.clientX); });
                window.addEventListener('mouseup', onEnd);
                knob.addEventListener('touchstart', (e) => { isDragging = true; startX = e.touches[0].clientX; }, {passive: false});
                knob.addEventListener('touchmove', (e) => { if(isDragging) onMove(e.touches[0].clientX); }, {passive: false});
                knob.addEventListener('touchend', onEnd);
            });
        }

        function completeMission(id) {
            const mission = getMissionById(id);
            if (!mission) return;
            confetti({ particleCount: 80, spread: 80, origin: { y: 0.6 }, colors: ['#2dd4bf', '#ffffff', '#fcd34d'] });
            gameState.xp += mission.xp;
            if (gameState.stats[mission.stat]) gameState.stats[mission.stat]++;
            gameState.activeIds = gameState.activeIds.filter(mid => mid !== id);
            gameState.completedIds.push({ id: id, date: new Date().toLocaleDateString() });
            replenishActiveMissions();
            showToast(`¡Integrado! +${mission.xp} XP`, 'success');
            saveGame();
            renderView();
        }

        function skipMission(id) {
            gameState.activeIds = gameState.activeIds.filter(mid => mid !== id);
            gameState.skippedIds.push(id);
            replenishActiveMissions();
            showToast("Evitado (Sin XP)", "neutral");
            saveGame();
            renderView();
        }

        function replenishActiveMissions() { if (gameState.activeIds.length < 4 && gameState.pendingIds.length > 0) gameState.activeIds.push(gameState.pendingIds.shift()); }
        function recoverSkipped(id) { gameState.skippedIds = gameState.skippedIds.filter(sid => sid !== id); gameState.pendingIds.unshift(id); replenishActiveMissions(); showToast("Recuperado", "success"); saveGame(); renderView(); }

        let currentView = 'missions'; 
        function renderView() {
            document.querySelectorAll('.nav-btn').forEach((btn, idx) => {
                const views = ['missions', 'mentor', 'origin', 'profile'];
                const isActive = views[idx] === currentView;
                const colors = ['text-teal-300', 'text-purple-300', 'text-amber-300', 'text-emerald-300'];
                if(isActive) btn.className = `nav-btn flex flex-col items-center ${colors[idx]} p-2 rounded-xl transition-all active:scale-95 group bg-white/5 shadow-inner border border-white/5`;
                else btn.className = `nav-btn flex flex-col items-center text-slate-600 p-2 rounded-xl transition-all active:scale-95 group hover:text-slate-400`;
            });

            const c = document.getElementById('appContent');
            c.innerHTML = ''; 
            if (currentView === 'missions') renderMissionsView(c);
            if (currentView === 'mentor') renderMentorView(c);
            if (currentView === 'origin') renderOriginView(c);
            if (currentView === 'profile') renderProfileView(c);
            lucide.createIcons();
        }

        window.renderMissions = () => { currentView = 'missions'; renderView(); };
        window.renderMentor = () => { currentView = 'mentor'; renderView(); };
        window.renderOrigin = () => { currentView = 'origin'; renderView(); };
        window.renderProfile = () => { currentView = 'profile'; renderView(); };

        function renderMissionsView(c) {
            c.insertAdjacentHTML('beforeend', `<div class="flex justify-between mb-6 fade-in items-end px-1"><div><h2 class="font-game text-xl text-white drop-shadow-md">Duelos Activos</h2><span class="text-[10px] text-teal-200/60 uppercase tracking-widest font-bold">Transforma tu realidad</span></div><span class="text-[10px] bg-slate-900/50 px-3 py-1 rounded-full border border-white/5 text-slate-400">Restantes: <b>${gameState.pendingIds.length}</b></span></div>`);
            
            if (gameState.activeIds.length === 0 && gameState.pendingIds.length === 0) {
                c.insertAdjacentHTML('beforeend', `<div class="text-center p-12 border border-dashed border-teal-500/20 rounded-3xl mt-10 glass-panel"><i data-lucide="crown" class="w-16 h-16 mx-auto text-amber-400 mb-6 drop-shadow-[0_0_15px_rgba(251,191,36,0.4)]"></i><h3 class="text-white font-bold text-xl font-game mb-2">¡Maestría Integrada!</h3><p class="text-slate-400 text-sm">Has completado el viaje del Héroe.</p></div>`);
                return;
            }

            gameState.activeIds.forEach((id, idx) => {
                const m = getMissionById(id);
                const html = `
                    <div class="card p-0 mb-6 border-l-4 ${m.color} fade-in relative overflow-hidden" style="animation-delay: ${idx * 100}ms">
                        <div class="p-6 pb-2">
                            <div class="flex justify-between items-center mb-3">
                                <span class="text-[9px] font-bold uppercase text-slate-400 tracking-[0.15em] bg-black/30 px-2 py-1 rounded border border-white/5">${m.villain} vs ${m.hero}</span>
                                <div class="flex items-center gap-2">
                                    <div class="text-[10px] font-bold text-teal-300 bg-teal-500/10 px-2 py-1 rounded border border-teal-500/20 shadow-[0_0_10px_rgba(20,184,166,0.1)]">+${m.xp} XP</div>
                                    <button onclick="showMissionDetails(${m.id})" class="text-slate-500 hover:text-white transition-colors p-1 hover:bg-white/10 rounded-lg">
                                        <i data-lucide="info" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <h3 class="font-bold text-white text-lg font-game leading-snug mb-2 drop-shadow-sm">${m.title}</h3>
                            <p class="text-sm text-slate-300/80 leading-relaxed font-light">${m.desc}</p>
                        </div>

                        <div class="w-full px-5 pb-6 pt-2">
                            <div class="slider-track" id="slider-${m.id}">
                                <div class="slider-fill-left"></div>
                                <div class="slider-fill-right"></div>
                                <div class="absolute inset-0 flex justify-between items-center px-5 text-[9px] font-bold uppercase tracking-[0.2em] pointer-events-none z-10 opacity-70">
                                    <span class="text-red-300 drop-shadow-md">Evitar</span>
                                    <span class="text-teal-300 drop-shadow-md">Integrar</span>
                                </div>
                                <div class="slider-knob" data-mission-id="${m.id}">
                                    <i data-lucide="chevrons-left-right" class="w-5 h-5 opacity-90"></i>
                                </div>
                            </div>
                        </div>
                    </div>`;
                c.insertAdjacentHTML('beforeend', html);
            });
            setTimeout(setupSliders, 100);
            c.insertAdjacentHTML('beforeend', FOOTER_HTML);
        }

        function renderMentorView(c) {
            c.insertAdjacentHTML('beforeend', `
                <div class="text-center mb-8 fade-in">
                    <div class="w-24 h-24 bg-gradient-to-br from-indigo-500 via-purple-600 to-indigo-800 rounded-full mx-auto flex items-center justify-center border-4 border-indigo-500/20 mb-4 shadow-[0_0_30px_rgba(99,102,241,0.3)] pulse-slow">
                        <i data-lucide="sparkles" class="w-10 h-10 text-white drop-shadow-md"></i>
                    </div>
                    <h2 class="font-game text-xl text-white tracking-wide">Oráculo Interior</h2>
                    <p class="text-xs text-slate-400 mt-2 font-light tracking-wider">Consulta la sabiduría de los Arquetipos</p>
                </div>
                <div id="chatBox" class="glass-panel rounded-2xl p-5 h-[320px] overflow-y-auto mb-5 border-white/5 flex flex-col gap-4 custom-scrollbar bg-slate-950/30">
                    <div class="self-start max-w-[85%]"><span class="bg-indigo-500/10 text-indigo-100 text-xs leading-relaxed px-4 py-3 rounded-2xl rounded-tl-sm inline-block border border-indigo-500/20 shadow-sm">Bienvenido al espacio de reflexión. Recuerda: no puedes eliminar a tus Villanos, pero puedes educarlos. ¿Quién te preocupa hoy?</span></div>
                </div>
                <div class="grid grid-cols-2 gap-3 fade-in">
                    <button onclick="addChat('judge')" class="btn-secondary p-3 rounded-xl text-[10px] uppercase font-bold tracking-wider text-slate-400 hover:bg-white/5 hover:text-white transition-all hover:border-white/20">El Juez</button>
                    <button onclick="addChat('victim')" class="btn-secondary p-3 rounded-xl text-[10px] uppercase font-bold tracking-wider text-slate-400 hover:bg-white/5 hover:text-white transition-all hover:border-white/20">La Víctima</button>
                    <button onclick="addChat('fear')" class="btn-secondary p-3 rounded-xl text-[10px] uppercase font-bold tracking-wider text-slate-400 hover:bg-white/5 hover:text-white transition-all hover:border-white/20">El Miedo</button>
                    <button onclick="addChat('wise')" class="btn-secondary p-3 rounded-xl text-[10px] uppercase font-bold tracking-wider text-teal-300 hover:bg-teal-500/10 hover:text-teal-200 transition-all border-teal-500/20 hover:border-teal-500/40">Mensaje Sabio</button>
                </div>
                ${FOOTER_HTML}
            `);
        }

        function renderOriginView(c) {
            c.insertAdjacentHTML('beforeend', `
                <div class="fade-in">
                    <div class="text-center mb-8">
                        <div class="inline-block p-4 rounded-full bg-amber-500/5 border border-amber-500/10 mb-4 shadow-[0_0_20px_rgba(245,158,11,0.1)]">
                            <i data-lucide="book-open" class="w-10 h-10 text-amber-400 drop-shadow-md"></i>
                        </div>
                        <h2 class="font-game text-2xl text-white mb-2 tracking-wide">El Libro</h2>
                        <div class="h-0.5 w-16 bg-gradient-to-r from-transparent via-amber-500 to-transparent mx-auto"></div>
                    </div>

                    <div class="glass-panel p-8 rounded-2xl border border-amber-500/10 shadow-2xl mb-8 relative overflow-hidden group hover:border-amber-500/20 transition-colors">
                        <div class="absolute top-0 right-0 w-32 h-32 bg-amber-500/5 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none"></div>
                        <div class="space-y-6 text-sm text-slate-300 leading-relaxed font-serif relative z-10">
                            <p class="first-letter:text-3xl first-letter:font-game first-letter:text-amber-400 first-letter:mr-1 first-letter:float-left">
                                Tu mente es un escenario habitado. No estás solo en tus pensamientos. En <strong>"El Lenguaje de la Mente"</strong>, la Dra. Maite Moyá desvela el mapa secreto de los 15 Arquetipos que gobiernan tu vida.
                            </p>
                            <p>
                                Descubrirás que esa voz crítica no eres tú, es <em>"El Juez"</em>. Que ese bloqueo no es incapacidad, es <em>"El Miedo"</em> disfrazado. Este libro no es solo lectura; es un manual de desactivación de bombas emocionales.
                            </p>
                            <blockquote class="pl-4 border-l-2 border-amber-500/40 italic text-slate-400 my-6 py-2">
                                "La verdadera libertad comienza cuando dejas de ser un personaje de tu propia historia para convertirte en el autor."
                            </blockquote>
                            <p>
                                Úsalo para convertir a tus Villanos internos en tus mayores aliados.
                            </p>
                        </div>
                    </div>

                    <a href="https://liderapia.com" target="_blank" class="block text-center p-5 bg-gradient-to-r from-amber-500/10 to-amber-600/10 rounded-xl border border-amber-500/20 hover:from-amber-500/20 hover:to-amber-600/20 transition-all group shadow-lg">
                        <span class="text-amber-200 font-bold text-xs uppercase tracking-widest flex items-center justify-center gap-3 group-hover:gap-4 transition-all">
                            Adquirir Sabiduría <i data-lucide="external-link" class="w-4 h-4 text-amber-400"></i>
                        </span>
                    </a>
                    ${FOOTER_HTML}
                </div>
            `);
        }

        function renderProfileView(c) {
            const completed = gameState.completedIds.length, skipped = gameState.skippedIds.length, total = ALL_MISSIONS.length;
            const prog = Math.round((completed / total) * 100);
            c.insertAdjacentHTML('beforeend', `
                <div class="fade-in">
                    <div class="flex items-center gap-6 mb-8 px-2">
                        <div class="relative">
                            <div class="w-20 h-20 rounded-full border-4 border-slate-800 flex items-center justify-center bg-slate-900 shadow-xl relative z-10">
                                <span class="font-game text-xl text-teal-400 font-bold">${prog}%</span>
                            </div>
                            <div class="absolute inset-0 rounded-full border-4 border-teal-500/30 blur-sm"></div>
                            <svg class="absolute top-0 left-0 w-full h-full -rotate-90 z-0 scale-110" viewBox="0 0 100 100">
                                <circle cx="50" cy="50" r="45" fill="none" stroke="#1e293b" stroke-width="4" />
                                <circle cx="50" cy="50" r="45" fill="none" stroke="#14b8a6" stroke-width="4" stroke-dasharray="283" stroke-dashoffset="${283 - (283 * prog / 100)}" stroke-linecap="round" />
                            </svg>
                        </div>
                        <div>
                            <h2 class="font-game text-xl text-white">Nivel de Integración</h2>
                            <p class="text-xs text-slate-400 font-light mt-1">Tu viaje hacia la maestría</p>
                        </div>
                    </div>

                    <div class="glass-panel rounded-2xl p-6 border-white/5 shadow-xl mb-8">
                         <div class="grid grid-cols-3 gap-4 text-center text-xs divide-x divide-white/10">
                            <div><span class="block text-teal-400 font-game text-2xl mb-1 drop-shadow-sm">${completed}</span>Integrados</div>
                            <div><span class="block text-red-400 font-game text-2xl mb-1 drop-shadow-sm">${skipped}</span>Evitados</div>
                            <div><span class="block text-slate-500 font-game text-2xl mb-1">${gameState.activeIds.length}</span>En Curso</div>
                        </div>
                    </div>

                    ${skipped > 0 ? `
                        <div class="mb-8">
                            <h3 class="text-[10px] font-bold text-red-400/80 uppercase tracking-widest mb-4 flex items-center gap-2 px-2">
                                <i data-lucide="refresh-ccw" class="w-3 h-3"></i> Sombras Pendientes
                            </h3>
                            <div class="space-y-3">
                                ${gameState.skippedIds.map(id => {
                                    const m = getMissionById(id);
                                    return `<div class="glass-panel p-4 rounded-xl flex justify-between items-center border-l-2 border-l-red-500/40 bg-slate-900/40 hover:bg-slate-800/60 transition-colors group">
                                        <div class="overflow-hidden mr-3">
                                            <span class="text-xs font-bold text-slate-300 block truncate group-hover:text-white transition-colors">${m.title}</span>
                                            <span class="text-[9px] text-red-400/60 uppercase tracking-wide">${m.villain}</span>
                                        </div>
                                        <button onclick="recoverSkipped(${m.id})" class="px-4 py-2 bg-white/5 hover:bg-red-500/20 text-slate-400 hover:text-red-200 text-[10px] font-bold uppercase tracking-wider rounded-lg transition-all border border-white/5">Reintentar</button>
                                    </div>`
                                }).join('')}
                            </div>
                        </div>` : ''}

                    <div class="mt-12 text-center">
                        <button onclick="if(confirm('¿Reiniciar todo el progreso?')){localStorage.removeItem('${SAVE_KEY}'); location.reload();}" class="group flex items-center justify-center gap-2 mx-auto px-6 py-3 rounded-full hover:bg-red-500/10 transition-all">
                            <i data-lucide="trash" class="w-4 h-4 text-red-400/40 group-hover:text-red-400 transition-colors"></i> 
                            <span class="text-xs font-bold text-red-400/40 group-hover:text-red-400 uppercase tracking-widest transition-colors">Reiniciar Viaje</span>
                        </button>
                    </div>
                    ${FOOTER_HTML}
                </div>
            `);
        }

        function updateUI() {
            for (const [key, val] of Object.entries(gameState.stats)) { const el = document.getElementById(`stat${key}`); if(el) el.innerText = val; }
            const percent = (gameState.xp / TOTAL_MAX_XP) * 100;
            let currentRank = RANKS[0], level = 1;
            for (let i = 0; i < RANKS.length; i++) { if (percent >= RANKS[i].threshold) { currentRank = RANKS[i]; level = i + 1; } }
            document.getElementById('currentXp').innerText = gameState.xp;
            document.getElementById('userLevel').innerText = level;
            document.getElementById('rankBadge').innerText = currentRank.title;
        }

        window.addChat = (type) => {
            const box = document.getElementById('chatBox');
            const messages = MENTOR_DATA[type];
            let idx;
            do { idx = Math.floor(Math.random() * messages.length); } while (messages.length > 1 && idx === lastChatIndices[type]);
            lastChatIndices[type] = idx;
            const randomMsg = messages[idx];
            const userLabels = {judge: "Siento mucha autocrítica...", victim: "Me siento impotente...", fear: "Tengo miedo...", wise: "Necesito perspectiva..."};
            box.insertAdjacentHTML('beforeend', `<div class="self-end max-w-[85%] slide-up mb-2 text-right"><span class="bg-white/10 text-white text-xs px-4 py-3 rounded-2xl rounded-tr-none inline-block backdrop-blur-sm border border-white/10">${userLabels[type]}</span></div>`);
            setTimeout(() => {
                box.insertAdjacentHTML('beforeend', `<div class="self-start max-w-[90%] slide-up mb-2"><span class="bg-indigo-500/20 text-indigo-100 text-xs px-4 py-3 rounded-2xl rounded-tl-none inline-block border border-indigo-500/20 shadow-sm leading-relaxed">${randomMsg}</span></div>`);
                box.scrollTop = box.scrollHeight;
            }, 600);
            box.scrollTop = box.scrollHeight;
        };

        window.showStatInfo = (k) => { 
            const d = STAT_DEFINITIONS[k]; 
            toggleModal(true, `
                <div class="text-center">
                    <div class="w-20 h-20 rounded-full bg-slate-900 mx-auto flex items-center justify-center mb-6 border-2 ${d.color.replace('text','border')} shadow-[0_0_25px_rgba(255,255,255,0.05)] relative overflow-hidden">
                        <div class="absolute inset-0 bg-white/5 animate-pulse"></div>
                        <i data-lucide="${d.icon}" class="w-10 h-10 ${d.color} relative z-10"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-white mb-1 font-game tracking-wide">${d.name}</h3>
                    <p class="text-[10px] text-slate-500 uppercase font-bold mb-6 tracking-[0.2em]">${d.archetype_group}</p>
                    <div class="text-slate-300 text-sm leading-loose mb-8 bg-slate-900/60 p-6 rounded-2xl border border-white/5 font-serif italic">
                        "${d.desc}"
                    </div>
                    <div class="flex justify-between items-center bg-white/5 p-4 rounded-xl border border-white/5 mb-6">
                        <span class="text-[10px] text-slate-500 uppercase font-bold tracking-widest">Nivel Actual</span>
                        <span class="text-2xl font-bold text-white font-game">${gameState.stats[k]}</span>
                    </div>
                    <button onclick="toggleModal(false)" class="w-full py-4 bg-slate-800 hover:bg-slate-700 text-white rounded-xl font-bold text-xs uppercase tracking-widest transition-colors">Entendido</button>
                </div>
            `); 
            lucide.createIcons(); 
        };

        function showHelp() {
            toggleModal(true, `
                <div class="text-center">
                    <div class="mb-6 inline-block relative">
                         <div class="absolute -inset-4 bg-teal-500/20 rounded-full blur-xl"></div>
                         <h2 class="font-game text-2xl text-transparent bg-clip-text bg-gradient-to-r from-teal-200 to-emerald-400 relative z-10">Bienvenido, Viajero</h2>
                    </div>
                    
                    <div class="text-left space-y-4 text-sm text-slate-300 mb-6 bg-slate-900/60 p-6 rounded-2xl border border-white/5 shadow-inner">
                        <p class="leading-relaxed font-serif">
                            <span class="text-white text-lg float-left mr-2 font-game text-teal-400">¿</span>Alguna vez has sentido que no eres tú quien lleva el volante de tu vida? Que una voz interna —crítica, miedosa, exigente— decide por ti. No estás solo. Es tu <strong>Villano</strong> tomando el control.
                        </p>
                        <p class="leading-relaxed">
                            En <em>"El Lenguaje de la Mente"</em>, la Dra. Maite Moyá nos revela que dentro de ti habitan 15 Arquetipos. Fuerzas que pueden ser tu cárcel... o tus alas.
                        </p>
                        <p class="leading-relaxed">
                            Este juego es tu <strong>gimnasio mental</strong>. Aquí no ganas puntos por vencer enemigos externos, sino por <strong>despertar</strong>. Por elegir conscientemente al Héroe sobre el Villano.
                        </p>
                    </div>

                    <!-- NUEVA SECCIÓN: INSTRUCCIONES DE JUEGO -->
                    <div class="text-left mb-6 bg-teal-900/20 p-5 rounded-2xl border border-teal-500/20">
                        <h3 class="font-game text-teal-300 text-xs uppercase tracking-widest mb-4 flex items-center gap-2 font-bold">
                            <i data-lucide="compass" class="w-4 h-4"></i> Instrucciones de Vuelo
                        </h3>
                        <ul class="space-y-3 text-xs text-slate-300">
                            <li class="flex items-start gap-3">
                                <div class="bg-teal-500/10 p-1.5 rounded-lg border border-teal-500/20 shrink-0">
                                    <i data-lucide="arrow-right" class="w-4 h-4 text-teal-400"></i>
                                </div>
                                <div>
                                    <strong class="text-teal-200 block mb-0.5">Desliza a la DERECHA</strong>
                                    <span>Para <em>Integrar</em> al Héroe. Elige la acción luminosa y gana XP.</span>
                                </div>
                            </li>
                            <li class="flex items-start gap-3">
                                <div class="bg-red-500/10 p-1.5 rounded-lg border border-red-500/20 shrink-0">
                                    <i data-lucide="arrow-left" class="w-4 h-4 text-red-400"></i>
                                </div>
                                <div>
                                    <strong class="text-red-200 block mb-0.5">Desliza a la IZQUIERDA</strong>
                                    <span>Para <em>Evitar</em> al Villano. Esquiva la trampa mental (sin XP).</span>
                                </div>
                            </li>
                            <li class="flex items-start gap-3">
                                <div class="bg-purple-500/10 p-1.5 rounded-lg border border-purple-500/20 shrink-0">
                                    <i data-lucide="bot" class="w-4 h-4 text-purple-400"></i>
                                </div>
                                <div>
                                    <strong class="text-purple-200 block mb-0.5">Consulta al Mentor</strong>
                                    <span>Si te sientes bloqueado, pide consejo al Oráculo en la pestaña Mentor.</span>
                                </div>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="mb-6 text-center pt-2 border-t border-white/5">
                        <p class="text-[10px] text-teal-200/60 uppercase tracking-widest font-bold">Juega para practicar. Lee para entender.</p>
                    </div>
                    
                    <button onclick="toggleModal(false)" class="w-full py-4 bg-gradient-to-r from-teal-700 to-emerald-800 hover:from-teal-600 hover:to-emerald-700 text-white rounded-xl font-bold text-xs uppercase tracking-[0.2em] shadow-lg shadow-emerald-900/50 transition-all transform active:scale-95">
                        Iniciar Mi Transformación
                    </button>
                </div>
            `);
            lucide.createIcons();
        }

        function showToast(msg, type) {
            const t = document.createElement('div');
            t.className = `glass-panel border ${type=='success'?'border-emerald-500/50 text-emerald-300':'border-slate-500/50 text-slate-300'} px-5 py-4 rounded-2xl shadow-2xl flex items-center gap-4 slide-up backdrop-blur-xl z-50`;
            t.innerHTML = `<i data-lucide="${type=='success'?'check-circle':'alert-circle'}" class="w-5 h-5"></i><span class="text-[10px] font-bold uppercase tracking-widest">${msg}</span>`;
            document.getElementById('toastContainer').appendChild(t);
            lucide.createIcons();
            setTimeout(()=>t.remove(), 3000);
        }

        function toggleModal(show, html=null) {
            const el = document.getElementById('modalOverlay');
            if(html) document.getElementById('dynamicModalBody').innerHTML = html;
            if(show) { el.classList.remove('hidden'); setTimeout(()=>el.classList.remove('opacity-0'),10); } else { el.classList.add('opacity-0'); setTimeout(()=>el.classList.add('hidden'),200); }
        }

        initGame();
    </script>
</body>
</html>
